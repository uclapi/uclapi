name: CI/CD

on:
  push

jobs:
  build:
    name: build and test
    runs-on: ubuntu-latest
    environment: Staging
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
        env:
          POSTGRES_PASSWORD: supersecure
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      postgres:
        image: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: setup nodejs
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: checkout code
        uses: actions/checkout@v2

      - name: setup build environment
        uses: ./.github/actions/setup-build-env

      - name: build frontend
        run: |
          cd ./frontend && \
          npm run build
      
      - name: run migrations
        env: # Or as an environment variable
          OCCUPEYE_BASE_URL: ${{ secrets.OCCUPEYE_BASE_URL }}
          OCCUPEYE_DEPLOYMENT_ID: ${{ secrets.OCCUPEYE_DEPLOYMENT_ID }}
          OCCUPEYE_DEPLOYMENT_NAME: ${{ secrets.OCCUPEYE_DEPLOYMENT_NAME }}
          OCCUPEYE_PASSWORD: ${{ secrets.OCCUPEYE_PASSWORD }}
          OCCUPEYE_THREAD_LIMIT: ${{ secrets.OCCUPEYE_THREAD_LIMIT }}
          OCCUPEYE_USERNAME: ${{ secrets.OCCUPEYE_USERNAME }}
          REDIS_UCLAPI_HOST: ${{ secrets.REDIS_UCLAPI_HOST }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          SHIB_TEST_USER: ${{ secrets.SHIB_TEST_USER }}
          UCLAPI_PRODUCTION: False
          UCLAPI_RUNNING_ON_AWS_ELB: False
          DB_UCLAPI_PASSWORD: supersecure
        run: |
          cd ./backend/uclapi && \
          python ./manage.py migrate

      - name: run our tests and check test coverage
        run: |
          coverage run --source='.' --omit='*migrations*' manage.py test --testrunner && \
          'uclapi.custom_test_runner.NoDbTestRunner' --settings=uclapi.settings_mocked && \
          codecov
